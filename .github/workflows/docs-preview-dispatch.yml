# Deploys preview artifacts produced by the Docs — Build & Preview workflow for PRs.
# The build workflow runs with read-only permissions on PRs (including forks) and
# uploads the built site as an artifact. This workflow runs in the base repo with
# the permissions needed to publish the preview to the gh-pages branch, but it
# never checks out or executes untrusted PR code.
name: Docs — Preview Deploy

on:
  workflow_run:
    workflows: ["Docs — Build & Preview"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: "Run ID of Docs — Build & Preview (artifact source)"
        required: true
      pr_number:
        description: "Pull request number"
        required: true
      head_branch:
        description: "Pull request head branch"
        required: true
      head_sha:
        description: "Pull request head SHA"
        required: true

permissions:
  contents: write
  actions: read
  pages: write

jobs:
  deploy-preview:
    if: >
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.event == 'pull_request' &&
       github.event.workflow_run.conclusion == 'success' &&
       (github.event.workflow_run.pull_requests || null))
      || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    env:
      RUN_ID: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.id || inputs.run_id }}
    steps:
      - name: Download built site artifact
        uses: actions/download-artifact@v4
        with:
          name: site
          path: site
          run-id: ${{ env.RUN_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Derive preview metadata
        id: meta
        env:
          HEAD_SHA: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || inputs.head_sha }}
          HEAD_BRANCH: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || inputs.head_branch }}
          PR_NUMBER: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.pull_requests[0].number || inputs.pr_number }}
        run: |
          set -euo pipefail
          short_sha="$(printf '%s' "$HEAD_SHA" | cut -c1-7)"
          {
            echo "short_sha=$short_sha"
            echo "head_branch=$HEAD_BRANCH"
            echo "pr_number=$PR_NUMBER"
          } >> "$GITHUB_OUTPUT"

      - name: Deploy preview under subfolder
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./site
          destination_dir: preview/${{ steps.meta.outputs.head_branch }}/${{ steps.meta.outputs.short_sha }}
          keep_files: true

      - name: Print preview URL
        env:
          PREVIEW_OWNER: ${{ github.repository_owner }}
          PREVIEW_REPO: ${{ github.repository }}
          HEAD_BRANCH: ${{ steps.meta.outputs.head_branch }}
          SHORT_SHA: ${{ steps.meta.outputs.short_sha }}
          PR_NUMBER: ${{ steps.meta.outputs.pr_number }}
        run: |
          echo "Preview for PR #${PR_NUMBER}:"
          echo "https://${PREVIEW_OWNER}.github.io/$(basename "$PREVIEW_REPO")/preview/${HEAD_BRANCH}/${SHORT_SHA}/"
